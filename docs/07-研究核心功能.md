# 步骤7：研究核心功能

## 🎯 任务目标

实现深度研究的核心功能，包括搜索、内容提取、分析和报告生成。

## 📋 具体任务

### 7.1 创建研究主流程

**任务描述：** 实现研究的主要控制流程。

**操作步骤：**
1. 创建`src/app/api/deep-research/main.ts`文件
2. 实现研究循环逻辑
3. 配置最大迭代次数
4. 实现流程控制

**核心功能：**
- 初始化研究状态
- 执行多轮研究循环
- 控制迭代次数
- 生成最终报告

**测试方法：**
- 准备创建一个`src/app/api/deep-research/__tests__/main.test.ts`文件，并在该文件中进行研究主流程的单元测试
- 测试研究循环的正确执行
- 验证迭代次数控制
- 检查状态更新正确性

### 7.2 实现搜索功能

**任务描述：** 实现网络搜索功能。

**操作步骤：**
1. 创建`src/app/api/deep-research/research-functions.ts`文件
2. 实现搜索函数
3. 配置搜索参数
4. 处理搜索结果

**搜索功能包括：**
- 使用Exa API进行搜索
- 过滤和清理搜索结果
- 限制结果数量
- 处理搜索错误

**测试方法：**
- 准备创建一个`src/app/api/deep-research/__tests__/search.test.ts`文件，并在该文件中进行搜索功能的单元测试
- 使用curl测试搜索API：`curl -X POST "http://localhost:3000/api/deep-research" -H "Content-Type: application/json" -d '{"topic": "test", "clarifications": []}'`
- 验证搜索结果格式正确
- 测试搜索错误处理

### 7.3 实现内容提取功能

**任务描述：** 实现从搜索结果中提取关键信息的功能。

**操作步骤：**
1. 实现内容提取函数
2. 配置LLM模型调用
3. 设计提取提示词
4. 处理提取结果

**提取功能包括：**
- 使用LLM分析内容
- 生成内容摘要
- 识别关键信息
- 处理提取错误

**测试方法：**
- 准备创建一个`src/app/api/deep-research/__tests__/extraction.test.ts`文件，并在该文件中进行内容提取的单元测试
- 测试不同内容类型的提取效果
- 验证提取结果的质量
- 检查提取时间性能

### 7.4 实现分析功能

**任务描述：** 实现研究结果的分析和评估功能。

**操作步骤：**
1. 实现分析函数
2. 配置分析模型
3. 设计分析提示词
4. 处理分析结果

**分析功能包括：**
- 评估内容充分性
- 识别信息缺口
- 生成后续搜索查询
- 决定是否继续研究

**测试方法：**
- 准备创建一个`src/app/api/deep-research/__tests__/analysis.test.ts`文件，并在该文件中进行分析功能的单元测试
- 测试不同研究阶段的分析结果
- 验证分析逻辑的正确性
- 检查分析决策的合理性

### 7.5 实现报告生成功能

**任务描述：** 实现最终研究报告的生成功能。

**操作步骤：**
1. 实现报告生成函数
2. 配置报告模型
3. 设计报告模板
4. 处理报告格式

**报告功能包括：**
- 整合所有研究结果
- 生成结构化报告
- 添加来源引用
- 格式化输出

**测试方法：**
- 准备创建一个`src/app/api/deep-research/__tests__/report.test.ts`文件，并在该文件中进行报告生成的单元测试
- 测试报告结构和内容
- 验证来源引用正确
- 检查报告格式质量

### 7.6 实现模型调用封装

**任务描述：** 创建统一的模型调用接口。

**操作步骤：**
1. 创建`src/app/api/deep-research/model-caller.ts`文件
2. 实现模型调用函数
3. 添加重试机制
4. 处理调用错误

**调用功能包括：**
- 支持结构化输出
- 支持文本生成
- 实现重试逻辑
- 统计token使用

**测试方法：**
- 准备创建一个`src/app/api/deep-research/__tests__/model-caller.test.ts`文件，并在该文件中进行模型调用的单元测试
- 测试不同模型的调用
- 验证重试机制有效性
- 检查token统计正确性

### 7.7 实现活动跟踪

**任务描述：** 实现研究活动的实时跟踪。

**操作步骤：**
1. 创建`src/app/api/deep-research/activity-tracker.ts`文件
2. 实现活动记录功能
3. 配置活动类型
4. 处理活动状态

**跟踪功能包括：**
- 记录研究步骤
- 更新活动状态
- 发送实时更新
- 处理活动错误

**测试方法：**
- 准备创建一个`src/app/api/deep-research/__tests__/activity-tracker.test.ts`文件，并在该文件中进行活动跟踪的单元测试
- 测试活动记录功能
- 验证状态更新正确性
- 检查实时更新机制

### 7.8 创建提示词模板

**任务描述：** 创建各种功能的提示词模板。

**操作步骤：**
1. 创建`src/app/api/deep-research/prompts.ts`文件
2. 定义各种提示词模板
3. 实现动态提示词生成
4. 优化提示词效果

**提示词类型：**
- 规划提示词
- 提取提示词
- 分析提示词
- 报告提示词

**测试方法：**
- 准备创建一个`src/app/api/deep-research/__tests__/prompts.test.ts`文件，并在该文件中进行提示词的单元测试
- 测试提示词生成正确性
- 验证提示词长度合理
- 检查提示词内容质量

## ✅ 完成标准

- [ ] 研究主流程实现完成
- [ ] 搜索功能实现完成
- [ ] 内容提取功能完成
- [ ] 分析功能实现完成
- [ ] 报告生成功能完成
- [ ] 模型调用封装完成
- [ ] 活动跟踪功能完成
- [ ] 提示词模板创建完成
- [ ] 所有测试通过

## 🔍 测试策略

**功能测试：**
- 测试每个研究步骤的正确性
- 验证研究循环的完整性
- 检查错误处理机制

**性能测试：**
- 测试研究完成时间
- 验证token使用效率
- 检查内存使用情况

**集成测试：**
- 测试完整研究流程
- 验证数据流正确性
- 检查端到端功能

## 📝 下一步

完成本步骤后，请继续 [08-前端组件开发.md](./08-前端组件开发.md) 开发用户界面组件。

