# 步骤3：状态管理

## 🎯 任务目标

使用Zustand实现全局状态管理，管理研究流程中的各种状态数据。

## 📋 具体任务

### 3.1 安装状态管理依赖

**任务描述：** 安装Zustand状态管理库。

**操作步骤：**
1. 安装`zustand`包
2. 确认TypeScript类型支持

**测试方法：**
- 检查`package.json`中包含zustand依赖
- 确认可以正常导入zustand

### 3.2 定义状态类型

**任务描述：** 定义研究状态的数据类型。

**需要定义的类型：**
- 研究主题（topic）
- 问题列表（questions）
- 答案列表（answers）
- 当前问题索引（currentQuestion）
- 完成状态（isCompleted）
- 加载状态（isLoading）
- 活动列表（activities）
- 来源列表（sources）
- 研究报告（report）

**测试方法：**
- 准备创建一个`src/store/__tests__/types.test.ts`文件，并在该文件中进行类型定义的单元测试
- 验证所有类型定义正确
- 检查类型之间的关联关系

### 3.3 创建状态存储

**任务描述：** 创建Zustand状态存储。

**操作步骤：**
1. 创建`src/store/deepResearch.ts`文件
2. 定义初始状态
3. 实现状态更新方法
4. 配置TypeScript类型

**需要实现的方法：**
- setTopic：设置研究主题
- setQuestions：设置问题列表
- setAnswers：设置答案列表
- setCurrentQuestion：设置当前问题索引
- setIsCompleted：设置完成状态
- setIsLoading：设置加载状态
- setActivities：设置活动列表
- setSources：设置来源列表
- setReport：设置研究报告

**测试方法：**
- 准备创建一个`src/store/__tests__/deepResearch.test.ts`文件，并在该文件中进行状态管理的单元测试
- 测试状态初始值正确
- 测试状态更新方法正常工作
- 测试状态持久化（如果需要）

### 3.4 实现状态持久化

**任务描述：** 实现状态的本地存储持久化。

**操作步骤：**
1. 配置Zustand持久化中间件
2. 设置存储键名
3. 处理序列化和反序列化

**测试方法：**
- 测试状态在页面刷新后是否正确恢复
- 测试状态在浏览器关闭重开后是否正确恢复
- 验证存储的数据格式正确

### 3.5 创建状态选择器

**任务描述：** 创建状态选择器以提高性能。

**操作步骤：**
1. 创建选择器函数
2. 优化组件重渲染
3. 实现状态订阅

**测试方法：**
- 测试选择器函数返回正确的状态片段
- 验证组件只在相关状态变化时重渲染
- 检查内存泄漏问题

## ✅ 完成标准

- [ ] Zustand成功安装和配置
- [ ] 所有状态类型正确定义
- [ ] 状态存储创建完成
- [ ] 状态更新方法正常工作
- [ ] 状态持久化功能正常
- [ ] 状态选择器优化完成

## 🔍 测试策略

**单元测试：**
- 测试状态初始值
- 测试状态更新方法
- 测试状态持久化功能
- 测试选择器函数

**集成测试：**
- 测试状态在组件中的使用
- 测试状态更新触发组件重渲染
- 测试状态持久化在真实场景中的表现

**性能测试：**
- 测试大量状态更新时的性能
- 测试内存使用情况
- 测试状态订阅的性能影响

## 📝 下一步

完成本步骤后，请继续 [04-API服务配置.md](./04-API服务配置.md) 配置外部API服务。

