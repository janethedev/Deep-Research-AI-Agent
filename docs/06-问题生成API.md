# 步骤6：问题生成API

## 🎯 任务目标

实现问题生成API，根据用户输入的研究主题生成澄清问题。

## 📋 具体任务

### 6.1 创建问题生成API路由

**任务描述：** 创建问题生成的API端点。

**操作步骤：**
1. 创建`src/app/api/generate-questions/route.ts`文件
2. 实现POST请求处理
3. 添加请求验证
4. 实现错误处理

**测试方法：**
- 使用Postman或curl测试API端点：`curl -X POST "http://localhost:3000/api/generate-questions" -H "Content-Type: application/json" -d '{"topic": "人工智能"}'`
- 验证请求体格式正确
- 测试错误请求的处理
- 检查响应格式符合预期

### 6.2 实现问题生成逻辑

**任务描述：** 实现使用LLM生成澄清问题的核心逻辑。

**操作步骤：**
1. 创建问题生成函数
2. 设计提示词模板
3. 配置LLM模型调用
4. 实现结果解析

**需要实现的功能：**
- 根据主题生成2-4个澄清问题
- 问题应该帮助缩小研究范围
- 问题应该识别特定方面、深度要求、视角偏好

**测试方法：**
- 准备创建一个`src/app/api/generate-questions/__tests__/question-generation.test.ts`文件，并在该文件中进行问题生成逻辑的单元测试
- 测试不同主题的问题生成效果
- 验证生成的问题数量在合理范围内
- 检查问题质量是否符合要求

### 6.3 配置LLM模型调用

**任务描述：** 配置用于问题生成的LLM模型。

**操作步骤：**
1. 选择合适的模型（如Llama 3.3 70B）
2. 配置模型参数
3. 实现结构化输出
4. 添加重试机制

**测试方法：**
- 准备创建一个`src/app/api/generate-questions/__tests__/model-call.test.ts`文件，并在该文件中进行模型调用的单元测试
- 测试模型响应时间
- 验证结构化输出格式正确
- 测试重试机制的有效性

### 6.4 实现提示词工程

**任务描述：** 设计和优化问题生成的提示词。

**操作步骤：**
1. 创建提示词模板
2. 添加示例和指导
3. 优化提示词结构
4. 实现动态提示词生成

**测试方法：**
- 准备创建一个`src/app/api/generate-questions/__tests__/prompts.test.ts`文件，并在该文件中进行提示词的单元测试
- 测试不同主题的提示词生成
- 验证提示词长度和结构合理
- 检查提示词是否包含必要的指导信息

### 6.5 添加输入验证

**任务描述：** 实现输入数据的验证和清理。

**操作步骤：**
1. 使用zod定义验证模式
2. 实现输入清理函数
3. 添加长度限制
4. 处理特殊字符

**测试方法：**
- 准备创建一个`src/app/api/generate-questions/__tests__/validation.test.ts`文件，并在该文件中进行输入验证的单元测试
- 测试有效输入的处理
- 测试无效输入的拒绝
- 验证输入清理功能正确

### 6.6 实现错误处理

**任务描述：** 实现完善的错误处理机制。

**操作步骤：**
1. 定义错误类型
2. 实现错误捕获
3. 添加日志记录
4. 返回友好的错误信息

**测试方法：**
- 准备创建一个`src/app/api/generate-questions/__tests__/error-handling.test.ts`文件，并在该文件中进行错误处理的单元测试
- 模拟各种错误情况
- 测试错误响应的格式
- 验证错误日志记录正确

## ✅ 完成标准

- [ ] 问题生成API路由创建完成
- [ ] 问题生成逻辑实现完成
- [ ] LLM模型调用配置完成
- [ ] 提示词工程实现完成
- [ ] 输入验证功能完成
- [ ] 错误处理机制完成
- [ ] 所有测试通过

## 🔍 测试策略

**API端点测试：**
- 使用Postman测试不同输入
- 验证响应格式和状态码
- 测试错误情况的处理

**功能测试：**
- 测试不同主题的问题生成
- 验证问题质量和相关性
- 检查生成时间性能

**集成测试：**
- 测试与前端组件的集成
- 验证数据流正确性
- 测试端到端功能

## 📝 下一步

完成本步骤后，请继续 [07-研究核心功能.md](./07-研究核心功能.md) 实现研究核心逻辑。

